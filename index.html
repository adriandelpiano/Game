<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Aventura Modular</title>
    <style>
        :root { --player-size: 10vmin; --item-size: 6vmin; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        body { transition: background 1s; }
        #game-container { position: relative; width: 100%; height: 100%; max-width: 1000px; overflow: hidden; margin: auto; }
        #player { position: absolute; width: var(--player-size); height: var(--player-size); font-size: calc(var(--player-size) * 0.8); text-align: center; line-height: var(--player-size); z-index: 20; }
        .item { position: absolute; width: var(--item-size); height: var(--item-size); font-size: calc(var(--item-size) * 0.9); text-align: center; line-height: var(--item-size); user-select: none; z-index: 5; }
        .projectile { position: absolute; width: 10px; height: 25px; background-color: #FFD700; border-radius: 5px; z-index: 15; }
        .hidden { display: none !important; }
        #ui-container { position: absolute; top: 15px; left: 15px; font-weight: bold; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); z-index: 100; }
        #game-over { top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3em; text-align: center; width: 100%; position: absolute; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); z-index: 100;}
    </style>
</head>
<body>
    <div id="game-container">
        <div id="ui-container">
            <div id="score">Puntos: 0</div>
            <div id="cash">Dinero: 0</div>
            <div id="health"></div>
        </div>
        <div id="player"></div>
        <div id="game-over" class="hidden">GAME OVER</div>
    </div>

    <script>
        class DOMManager {
            constructor() {
                this.gameContainer = document.getElementById('game-container');
                this.player = document.getElementById('player');
                this.score = document.getElementById('score');
                this.cash = document.getElementById('cash');
                this.health = document.getElementById('health');
                this.gameOver = document.getElementById('game-over');
            }
            updateScore(score) { this.score.textContent = `Puntos: ${score}`; }
            updateCash(cash) { this.cash.textContent = `Dinero: ${cash}`; }
            updateHealth(health) { this.health.textContent = '‚ù§Ô∏è'.repeat(health); }
            setPlayerPosition(x, y) {
                this.player.style.left = `${x}%`;
                this.player.style.bottom = `${y}%`;
            }
            setPlayerEmoji(emoji) { this.player.textContent = emoji; }
            setBackground(background) { document.body.style.background = background; }
            createItemElement(item) {
                const el = document.createElement('div');
                el.classList.add('item');
                el.textContent = item.emoji;
                el.style.left = `${item.x}%`;
                el.style.top = `${item.y}%`;
                this.gameContainer.appendChild(el);
                return el;
            }
            createProjectileElement(p) {
                const el = document.createElement('div');
                el.classList.add('projectile');
                el.style.left = `${p.x}px`;
                el.style.top = `${p.y}px`;
                this.gameContainer.appendChild(el);
                return el;
            }
            showGameOver() { this.gameOver.classList.remove('hidden'); }
            hideUI(elements) {
                elements.forEach(el => this[el].classList.add('hidden'));
            }
            showUI(elements) {
                elements.forEach(el => this[el].classList.remove('hidden'));
            }
        }

        class Game {
            constructor(levels) {
                this.dom = new DOMManager();
                this.levels = levels;
                this.currentLevelIndex = 0;
                this.gameState = { score: 0, cash: 0, health: 3 };
                this.keysPressed = { ArrowLeft: false, ArrowRight: false, ArrowUp: false, ArrowDown: false, ' ': false };
                this.gameLoopId = null;
                this.itemIntervalId = null;

                window.addEventListener('keydown', (e) => { if (this.keysPressed.hasOwnProperty(e.key)) this.keysPressed[e.key] = true; });
                window.addEventListener('keyup', (e) => { if (this.keysPressed.hasOwnProperty(e.key)) this.keysPressed[e.key] = false; });
            }

            start() {
                this.loadLevel(this.levels[this.currentLevelIndex]);
                this.gameLoop();
            }

            loadLevel(LevelClass) {
                this.currentLevel = new LevelClass(this.gameState, this.dom, this.keysPressed);
                this.currentLevel.init();
                this.dom.setBackground(this.currentLevel.background);
                this.dom.setPlayerEmoji(this.currentLevel.playerEmoji);
                this.dom.updateScore(this.gameState.score);
                this.dom.updateCash(this.gameState.cash);
                this.dom.updateHealth(this.gameState.health);

                clearInterval(this.itemIntervalId);
                this.itemIntervalId = setInterval(() => this.currentLevel.createItem(), this.currentLevel.itemInterval);
            }

            gameLoop() {
                this.currentLevel.update();
                if (this.currentLevel.checkGoal()) {
                    this.nextLevel();
                }
                this.gameLoopId = requestAnimationFrame(() => this.gameLoop());
            }

            nextLevel() {
                this.currentLevelIndex++;
                if (this.currentLevelIndex < this.levels.length) {
                    this.loadLevel(this.levels[this.currentLevelIndex]);
                } else {
                    this.gameOver();
                }
            }
            
            gameOver() {
                cancelAnimationFrame(this.gameLoopId);
                clearInterval(this.itemIntervalId);
                this.dom.showGameOver();
            }
        }

        class Level {
            constructor(gameState, dom, keysPressed) {
                this.gameState = gameState;
                this.dom = dom;
                this.keys = keysPressed;
                this.items = [];
                this.projectiles = [];
                this.player = { x: 50, y: 10, speed: 2 };
            }
            init() { 
                this.gameState.score = 0;
                this.dom.updateScore(0);
            }
            update() { 
                this.updatePlayer(); 
                this.updateItems(); 
                this.updateProjectiles(); 
            }
            checkGoal() { return false; }
            
            updatePlayer() {
                // Implemented by subclasses
            }

            createItem() {
                // Implemented by subclasses
            }

            updateItems() {
                this.items.forEach((item, index) => {
                    item.update();
                    if (this.checkCollision(item.element)) {
                        this.onCollision(item);
                        this.items.splice(index, 1);
                        item.element.remove();
                    } else if (item.isOffscreen()) {
                        this.items.splice(index, 1);
                        item.element.remove();
                    }
                });
            }
            
            updateProjectiles() {
                this.projectiles.forEach((p, pIndex) => {
                    p.y -= 15;
                    p.element.style.top = `${p.y}px`;
                    if (p.y < 0) {
                        this.projectiles.splice(pIndex, 1);
                        p.element.remove();
                        return;
                    }
                    this.items.forEach((item, iIndex) => {
                        if (item.collidable && this.checkCollision(p.element, item.element)) {
                            this.projectiles.splice(pIndex, 1);
                            p.element.remove();
                            this.items.splice(iIndex, 1);
                            item.element.remove();
                            this.gameState.score += item.value || 10;
                            this.dom.updateScore(this.gameState.score);
                        }
                    });
                });
            }

            checkCollision(el1, el2 = this.dom.player) {
                const rect1 = el1.getBoundingClientRect();
                const rect2 = el2.getBoundingClientRect();
                return !(rect1.right < rect2.left || rect1.left > rect2.right || rect1.bottom < rect2.top || rect1.top > rect2.bottom);
            }

            onCollision(item) {
                if (item.value) this.gameState.score += item.value;
                if (item.cash) this.gameState.cash += item.cash;
                this.dom.updateScore(this.gameState.score);
                this.dom.updateCash(this.gameState.cash);
            }
        }

        class WaterLevel extends Level {
            constructor(gameState, dom, keysPressed) {
                super(gameState, dom, keysPressed);
                this.background = 'linear-gradient(to bottom, #87CEEB 0%, #B2FFFF 80%)';
                this.playerEmoji = 'üö§';
                this.itemInterval = 1500;
                this.itemTypes = [
                    { emoji: 'üíé', value: 50, name: 'treasure' }, { emoji: 'üçé', value: 10, name: 'fruit' },
                    { emoji: 'üí∞', cash: 50, name: 'cash' }, { emoji: 'üóëÔ∏è', value: -25, name: 'trash' }
                ];
            }
            
            init() {
                super.init();
                this.dom.showUI(['score', 'cash']);
                this.dom.hideUI(['health']);
                this.player.y = 10;
            }

            updatePlayer() {
                if (this.keys.ArrowLeft) this.player.x -= this.player.speed;
                if (this.keys.ArrowRight) this.player.x += this.player.speed;
                this.player.x = Math.max(0, Math.min(90, this.player.x));
                this.dom.setPlayerPosition(this.player.x, this.player.y);
            }

            createItem() {
                const itemData = this.itemTypes[Math.floor(Math.random() * this.itemTypes.length)];
                const item = new Item(itemData);
                item.element = this.dom.createItemElement(item);
                this.items.push(item);
            }
            
            checkGoal() {
                return this.gameState.cash >= 200; // Goal to transition
            }
        }
        
        class SpaceLevel extends Level {
            constructor(gameState, dom, keysPressed) {
                super(gameState, dom, keysPressed);
                this.background = '#000';
                this.playerEmoji = 'üöÄ';
                this.itemInterval = 400;
                this.canShoot = true;
                this.shootCooldown = 400;
                this.itemTypes = [
                    { emoji: '‚òÑÔ∏è', name: 'asteroid', collidable: true, value: 10 },
                    { emoji: 'üëΩ', name: 'alien', collidable: true, value: 25 },
                    { emoji: '‚≠ê', name: 'star', value: 50 }
                ];
            }

            init() {
                super.init();
                this.dom.showUI(['score', 'health']);
                this.dom.hideUI(['cash']);
                this.player.y = 5;
            }

            updatePlayer() {
                if (this.keys.ArrowLeft) this.player.x -= this.player.speed;
                if (this.keys.ArrowRight) this.player.x += this.player.speed;
                this.player.x = Math.max(0, Math.min(90, this.player.x));
                this.dom.setPlayerPosition(this.player.x, this.player.y);
                if (this.keys[' ']) this.shoot();
            }

            createItem() {
                const itemData = this.itemTypes[Math.floor(Math.random() * this.itemTypes.length)];
                const item = new Item(itemData);
                item.element = this.dom.createItemElement(item);
                this.items.push(item);
            }

            shoot() {
                if (!this.canShoot) return;
                this.canShoot = false;
                setTimeout(() => this.canShoot = true, this.shootCooldown);
                const playerRect = this.dom.player.getBoundingClientRect();
                const p = { x: playerRect.left + (playerRect.width / 2) - 5, y: playerRect.top };
                p.element = this.dom.createProjectileElement(p);
                this.projectiles.push(p);
            }
            
            onCollision(item) {
                if (item.collidable) {
                    this.gameState.health--;
                    this.dom.updateHealth(this.gameState.health);
                    if (this.gameState.health <= 0) game.gameOver();
                } else {
                    super.onCollision(item);
                }
            }

            checkGoal() {
                return this.gameState.score >= 500;
            }
        }

        class EarthLevel extends Level {
            constructor(gameState, dom, keysPressed) {
                super(gameState, dom, keysPressed);
                this.background = '#666';
                this.playerEmoji = 'üöó';
                this.itemInterval = 1000;
                this.itemTypes = [
                    { emoji: 'üí∞', cash: 100, name: 'cash' },
                    { emoji: 'üöô', value: -200, name: 'obstacle' }
                ];
            }

            init() {
                super.init();
                this.dom.showUI(['score', 'cash']);
                this.dom.hideUI(['health']);
                this.player.x = 10;
                this.player.y = 50;
            }

            updatePlayer() {
                if (this.keys.ArrowUp) this.player.y += this.player.speed;
                if (this.keys.ArrowDown) this.player.y -= this.player.speed;
                this.player.y = Math.max(0, Math.min(90, this.player.y));
                this.dom.setPlayerPosition(this.player.x, this.player.y);
            }

            createItem() {
                const itemData = this.itemTypes[Math.floor(Math.random() * this.itemTypes.length)];
                const item = new Item(itemData, true); // isHorizontal
                item.element = this.dom.createItemElement(item);
                this.items.push(item);
            }
            
            checkGoal() {
                return this.gameState.score >= 1000;
            }
        }
        
        class Item {
            constructor(data, isHorizontal = false) {
                this.x = isHorizontal ? 100 : Math.random() * 95;
                this.y = isHorizontal ? Math.random() * 90 : -5;
                this.speed = Math.random() * 3 + 1;
                this.emoji = data.emoji;
                this.value = data.value;
                this.cash = data.cash;
                this.name = data.name;
                this.collidable = data.collidable;
                this.isHorizontal = isHorizontal;
            }

            update() {
                if (this.isHorizontal) {
                    this.x -= this.speed;
                } else {
                    this.y += this.speed;
                }
                this.element.style.left = `${this.x}%`;
                this.element.style.top = `${this.y}%`;
            }

            isOffscreen() {
                return this.y > 100 || this.x < -5;
            }
        }

        const game = new Game([WaterLevel, SpaceLevel, EarthLevel]);
        game.start();

    </script>
</body>
</html>